<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô</title>

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-image: url('jpcity.jfif'); /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ */
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      padding: 20px;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .ui-shadow {
      text-shadow: 0 1px 3px #000;
    }

    h1 {
      text-align: center;
      color: #fff;
      margin-bottom: 12px;
    }

    h1.ui-shadow {
      text-shadow: 0 2px 6px #000;
    }

    .digital-clock {
      font-size: 2rem;
      color: cyan;
      font-family: 'Courier New', Courier, monospace;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px 20px;
      border-radius: 10px;
      box-shadow: 0 0 20px cyan;
      min-width: 240px;
      text-align: center;
      margin-bottom: 16px;
    }

    .app-container {
      width: 100%;
      max-width: 1000px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card {
      background: rgba(255, 255, 255, 0.35);
      border-radius: 12px;
      padding: 14px 16px;
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255, 255, 255, 0.6);
    }

    .card-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 8px;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }

    textarea,
    input[type="date"],
    input[type="time"] {
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.7);
      padding: 8px 10px;
      background: rgba(0, 0, 0, 0.4);
      color: #ffffff;
      outline: none;
      box-shadow: inset 0 0 4px rgba(0, 0, 0, 0.5);
    }

    textarea {
      width: 100%;
      min-height: 120px;
      resize: vertical;
      font-size: 1rem;
      line-height: 1.4;
    }

    input[type="date"],
    input[type="time"] {
      flex: 1 1 120px;
      min-width: 120px;
      font-size: 0.95rem;
    }

    textarea::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 6px 14px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .btn-main {
      background: linear-gradient(135deg, #03dffc, #0084ff);
      color: #001018;
      box-shadow: 0 4px 10px rgba(0, 132, 255, 0.7);
    }

    .btn-main:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0, 132, 255, 0.6);
    }

    .btn-complete {
      background: rgba(0, 200, 83, 0.95);
      color: #ffffff;
      box-shadow: 0 3px 8px rgba(0, 200, 83, 0.7);
    }

    .btn-delete {
      background: rgba(244, 67, 54, 0.95);
      color: #ffffff;
      box-shadow: 0 3px 8px rgba(244, 67, 54, 0.7);
    }

    .btn-priority {
      background: rgba(255, 215, 0, 0.98);
      color: #3b2a00;
      box-shadow: 0 3px 8px rgba(255, 215, 0, 0.8);
    }

    .lists-container {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap: 12px;
    }

    .list-title {
      font-size: 1rem;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 6px;
    }

    .list-subtitle {
      font-size: 0.85rem;
      color: #e0f7ff;
      margin-bottom: 6px;
      opacity: 0.9;
    }

    .task-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 380px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .task-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 8px 10px;
      border-radius: 10px;
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.65), rgba(0, 40, 80, 0.9));
      border-left: 4px solid rgba(3, 223, 252, 0.9);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
    }

    .task-priority {
      border-left-color: rgba(255, 215, 0, 0.98);
      box-shadow: 0 0 12px rgba(255, 215, 0, 0.9);
    }

    .task-top-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }

    .task-text {
      font-size: 1rem;
      color: #ffffff;
    }

    .task-meta {
      font-size: 0.8rem;
      color: #d0f3ff;
    }

    .task-remaining {
      font-size: 0.8rem;
      color: #ffeb3b;
    }

    .task-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }

    .task-empty {
      font-size: 0.9rem;
      color: #e0f7ff;
      opacity: 0.8;
    }

    .task-completed .task-text,
    .task-completed .task-meta,
    .task-completed .task-remaining {
      color: #c0c0c0 !important;
    }

    .task-completed {
      border-left-color: rgba(160, 160, 160, 0.9);
      background: rgba(0, 0, 0, 0.4);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.6);
    }

    @media (max-width: 768px) {
      .lists-container {
        grid-template-columns: minmax(0, 1fr);
      }

      .digital-clock {
        width: 100%;
        min-width: auto;
        text-align: center;
      }
    }
  </style>
</head>

<body>
  <h1 class="ui-shadow">‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô</h1>

  <!-- ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏£‡∏¥‡∏á -->
  <div class="digital-clock ui-shadow" id="digital-clock">00:00:00</div>

  <div class="app-container">

    <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô -->
    <div class="card">
      <div class="card-title ui-shadow">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</div>
      <div class="list-subtitle ui-shadow">
        ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î <b>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</b> ‡∏´‡∏£‡∏∑‡∏≠ <b>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</b><br>
        ‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î + ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô Firebase Firestore
      </div>

      <div class="form-row">
        <textarea id="task-text" class="ui-shadow" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡∏Ñ‡∏ì‡∏¥‡∏ï ‡∏´‡∏ô‡πâ‡∏≤ 52 ‡∏Ç‡πâ‡∏≠ 1-10"></textarea>
      </div>
      <div class="form-row">
        <input type="date" id="task-date" class="ui-shadow">
        <input type="time" id="task-time" class="ui-shadow">
        <button id="add-task" class="btn-main ui-shadow">Ôºã ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</button>
      </div>
    </div>

    <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏á‡∏≤‡∏ô -->
    <div class="lists-container">
      <!-- ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ -->
      <div class="card">
        <div class="list-title ui-shadow">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ (To-Do)</div>
        <div class="list-subtitle ui-shadow">
          ‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Leaderboard: ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç + ‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î
        </div>
        <div id="pending-list" class="task-list"></div>
      </div>

      <!-- ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß -->
      <div class="card">
        <div class="list-title ui-shadow">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</div>
        <div class="list-subtitle ui-shadow">
          ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏î‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô 7 ‡∏ß‡∏±‡∏ô (‡∏•‡∏ö‡∏à‡∏≤‡∏Å Firestore)
        </div>
        <div id="completed-list" class="task-list"></div>
      </div>
    </div>
  </div>

  <!-- ============ FIREBASE + FIRESTORE SCRIPT ============ -->
  <script type="module">
    /********** 1) IMPORT FIREBASE (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô [VERSION] ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î) **********/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      doc,
      setDoc,
      deleteDoc,
      onSnapshot,
      query,
      orderBy
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    /********** 2) CONFIG ‡∏à‡∏≤‡∏Å‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì **********/
    const firebaseConfig = {
      apiKey: "AIzaSyDP66sMOqA0i-k4rke1Vs4RPDrexUSrUkE",
      authDomain: "homework-task-manager.firebaseapp.com",
      databaseURL: "https://homework-task-manager-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "homework-task-manager",
      storageBucket: "homework-task-manager.firebasestorage.app",
      messagingSenderId: "912847790254",
      appId: "1:912847790254:web:0bbe7e111e3630b6618d3f",
      measurementId: "G-NRRRGX4T4K"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const tasksCol = collection(db, "tasks");

    /********** 3) DOM ELEMENTS **********/
    const digitalClock = document.getElementById('digital-clock');

    const taskTextInput = document.getElementById('task-text');
    const taskDateInput = document.getElementById('task-date');
    const taskTimeInput = document.getElementById('task-time');
    const addTaskBtn = document.getElementById('add-task');

    const pendingListEl = document.getElementById('pending-list');
    const completedListEl = document.getElementById('completed-list');

    let tasks = [];
    let editingId = null;

    /********** 4) ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏£‡∏¥‡∏á **********/
    function updateRealTimeClock() {
      const now = new Date();
      const h = now.getHours().toString().padStart(2, '0');
      const m = now.getMinutes().toString().padStart(2, '0');
      const s = now.getSeconds().toString().padStart(2, '0');
      if (digitalClock) {
        digitalClock.textContent = `${h}:${m}:${s}`;
      }
    }
    setInterval(updateRealTimeClock, 1000);
    updateRealTimeClock();

    /********** 5) Utils **********/
    function makeDueDate(dateStr, timeStr) {
      if (!dateStr || !timeStr) return null;
      const iso = `${dateStr}T${timeStr}:00`;
      const d = new Date(iso);
      if (isNaN(d.getTime())) return null;
      return d;
    }

    function formatDueDisplay(d) {
      const dd = d.getDate().toString().padStart(2, '0');
      const mm = (d.getMonth() + 1).toString().padStart(2, '0');
      const yyyy = d.getFullYear();
      const hh = d.getHours().toString().padStart(2, '0');
      const min = d.getMinutes().toString().padStart(2, '0');
      return `${dd}/${mm}/${yyyy} ‡πÄ‡∏ß‡∏•‡∏≤ ${hh}:${min} ‡∏ô.`;
    }

    function computeRemainingMs(due) {
      const now = new Date();
      return due.getTime() - now.getTime();
    }

    function remainingText(ms) {
      const sign = ms >= 0 ? 1 : -1;
      const abs = Math.abs(ms);
      const totalMinutes = Math.floor(abs / (1000 * 60));
      const days = Math.floor(totalMinutes / (60 * 24));
      const hours = Math.floor((totalMinutes % (60 * 24)) / 60);
      const minutes = totalMinutes % 60;

      let base = '';
      if (days > 0) base += `${days} ‡∏ß‡∏±‡∏ô `;
      if (hours > 0) base += `${hours} ‡∏ä‡∏°. `;
      if (minutes > 0 || (!days && !hours && minutes === 0)) base += `${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ`;

      if (sign >= 0) {
        return `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤ ${base.trim()}`;
      } else {
        return `‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß ${base.trim()}`;
      }
    }

    function remainingColor(ms) {
      const oneDayMs = 24 * 60 * 60 * 1000;
      const red = { r: 255, g: 59, b: 48 };
      const blue = { r: 3, g: 223, b: 252 };

      if (ms <= 0) {
        return 'rgb(255, 20, 20)';
      }

      if (ms <= oneDayMs) {
        return 'rgb(255, 59, 48)';
      }

      const sevenDayMs = 7 * oneDayMs;
      const tRaw = (ms - oneDayMs) / (sevenDayMs - oneDayMs);
      const t = Math.max(0, Math.min(1, tRaw));
      const r = Math.round(red.r + (blue.r - red.r) * t);
      const g = Math.round(red.g + (blue.g - red.g) * t);
      const b = Math.round(red.b + (blue.b - red.b) * t);

      return `rgb(${r}, ${g}, ${b})`;
    }

    /********** 6) ‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà complete ‡πÄ‡∏Å‡∏¥‡∏ô 7 ‡∏ß‡∏±‡∏ô ‡∏à‡∏≤‡∏Å Firestore **********/
    async function cleanupCompletedInDb() {
      const now = Date.now();
      const sevenDays = 7 * 24 * 60 * 60 * 1000;
      const toDelete = tasks.filter(
        t => t.completed && t.completedAt && (now - t.completedAt > sevenDays)
      );
      for (const t of toDelete) {
        try {
          await deleteDoc(doc(db, "tasks", t.id));
        } catch (err) {
          console.error("‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:", err);
        }
      }
    }

    /********** 7) Render Tasks **********/
    function renderTasks() {
      if (!pendingListEl || !completedListEl) return;

      pendingListEl.innerHTML = '';
      completedListEl.innerHTML = '';

      const pending = tasks
        .filter(t => !t.completed)
        .sort((a, b) => {
          if (a.priority && !b.priority) return -1;
          if (!a.priority && b.priority) return 1;
          const da = new Date(a.due).getTime() - new Date(b.due).getTime();
          if (da !== 0) return da;
          return (a.createdAt || 0) - (b.createdAt || 0);
        });

      const completed = tasks
        .filter(t => t.completed)
        .sort((a, b) => (b.completedAt || 0) - (a.completedAt || 0));

      if (pending.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'task-empty ui-shadow';
        empty.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥';
        pendingListEl.appendChild(empty);
      }

      if (completed.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'task-empty ui-shadow';
        empty.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß';
        completedListEl.appendChild(empty);
      }

      for (const t of pending) {
        pendingListEl.appendChild(createTaskElement(t, false));
      }
      for (const t of completed) {
        completedListEl.appendChild(createTaskElement(t, true));
      }

      updateRemainingDisplayAll();
    }

    function createTaskElement(task, isCompleted) {
      const due = new Date(task.due);
      const ms = computeRemainingMs(due);

      const wrapper = document.createElement('div');
      wrapper.className = 'task-item ui-shadow' +
        (isCompleted ? ' task-completed' : '') +
        (task.priority && !isCompleted ? ' task-priority' : '');
      wrapper.dataset.id = task.id;

      const topRow = document.createElement('div');
      topRow.className = 'task-top-row';

      const textEl = document.createElement('div');
      textEl.className = 'task-text ui-shadow';
      textEl.id = `task-text-${task.id}`;
      textEl.textContent = task.text;

      const metaCol = document.createElement('div');
      metaCol.style.textAlign = 'right';

      const dueEl = document.createElement('div');
      dueEl.className = 'task-meta ui-shadow';
      dueEl.textContent = `‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á: ${formatDueDisplay(due)}`;

      const remainingEl = document.createElement('div');
      remainingEl.className = 'task-remaining ui-shadow';
      remainingEl.id = `task-remaining-${task.id}`;
      remainingEl.textContent = remainingText(ms);
      remainingEl.style.color = remainingColor(ms);

      metaCol.appendChild(dueEl);
      metaCol.appendChild(remainingEl);

      topRow.appendChild(textEl);
      topRow.appendChild(metaCol);

      const btnRow = document.createElement('div');
      btnRow.className = 'task-buttons';

      if (!isCompleted) {
        const priorityBtn = document.createElement('button');
        priorityBtn.className = 'btn-priority ui-shadow';
        priorityBtn.textContent = task.priority ? '‚≠ê ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç' : '‚≠ê ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç';
        priorityBtn.dataset.id = task.id;
        priorityBtn.dataset.action = 'priority';
        btnRow.appendChild(priorityBtn);

        const editBtn = document.createElement('button');
        editBtn.className = 'btn-main ui-shadow';
        editBtn.textContent = '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
        editBtn.dataset.id = task.id;
        editBtn.dataset.action = 'edit';
        btnRow.appendChild(editBtn);

        const completeBtn = document.createElement('button');
        completeBtn.className = 'btn-complete ui-shadow';
        completeBtn.textContent = '‚úÖ ‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß';
        completeBtn.dataset.id = task.id;
        completeBtn.dataset.action = 'complete';
        btnRow.appendChild(completeBtn);
      }

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn-delete ui-shadow';
      deleteBtn.textContent = 'üóë ‡∏•‡∏ö‡∏á‡∏≤‡∏ô';
      deleteBtn.dataset.id = task.id;
      deleteBtn.dataset.action = 'delete';
      btnRow.appendChild(deleteBtn);

      wrapper.appendChild(topRow);
      wrapper.appendChild(btnRow);

      return wrapper;
    }

    function updateRemainingDisplayAll() {
      for (const t of tasks) {
        const due = new Date(t.due);
        const ms = computeRemainingMs(due);
        const remainingEl = document.getElementById(`task-remaining-${t.id}`);
        const textEl = document.getElementById(`task-text-${t.id}`);

        if (remainingEl && !t.completed) {
          remainingEl.textContent = remainingText(ms);
          const c = remainingColor(ms);
          remainingEl.style.color = c;
          if (textEl) {
            textEl.style.color = c;
          }
        } else if (t.completed && remainingEl && textEl) {
          remainingEl.textContent = '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß';
        }
      }
    }

    function resetForm() {
      taskTextInput.value = '';
      editingId = null;
      addTaskBtn.textContent = 'Ôºã ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô';
    }

    /********** 8) ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô ‚Üí Firestore **********/
    addTaskBtn.addEventListener('click', async () => {
      const text = (taskTextInput.value || '').trim();
      const dateStr = taskDateInput.value;
      const timeStr = taskTimeInput.value;

      if (!text) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô');
        return;
      }

      const due = makeDueDate(dateStr, timeStr);
      if (!due) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
        return;
      }

      try {
        if (editingId) {
          const ref = doc(db, "tasks", editingId);
          await setDoc(ref, {
            text,
            due: due.toISOString()
          }, { merge: true });
        } else {
          await addDoc(tasksCol, {
            text,
            due: due.toISOString(),
            completed: false,
            createdAt: Date.now(),
            completedAt: null,
            priority: false
          });
        }
        resetForm();
      } catch (err) {
        console.error("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
      }
    });

    /********** 9) ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≤‡∏á ‡πÜ ‡∏ö‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏á‡∏≤‡∏ô **********/
    async function handleListClick(e) {
      const target = e.target;
      if (!(target instanceof HTMLElement)) return;
      const id = target.dataset.id;
      const action = target.dataset.action;
      if (!id || !action) return;

      const t = tasks.find(t => t.id === id);
      if (!t) return;

      const ref = doc(db, "tasks", id);

      try {
        if (action === 'delete') {
          await deleteDoc(ref);
        } else if (action === 'complete') {
          if (!t.completed) {
            await setDoc(ref, {
              completed: true,
              completedAt: Date.now()
            }, { merge: true });
          }
        } else if (action === 'priority') {
          await setDoc(ref, {
            priority: !t.priority
          }, { merge: true });
        } else if (action === 'edit') {
          if (t.completed) return;
          const d = new Date(t.due);
          const yyyy = d.getFullYear();
          const mm = (d.getMonth() + 1).toString().padStart(2, '0');
          const dd = d.getDate().toString().padStart(2, '0');
          const hh = d.getHours().toString().padStart(2, '0');
          const min = d.getMinutes().toString().padStart(2, '0');

          taskTextInput.value = t.text;
          taskDateInput.value = `${yyyy}-${mm}-${dd}`;
          taskTimeInput.value = `${hh}:${min}`;

          editingId = t.id;
          addTaskBtn.textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      } catch (err) {
        console.error("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
      }
    }

    pendingListEl.addEventListener('click', handleListClick);
    completedListEl.addEventListener('click', handleListClick);

    /********** 10) ‡πÄ‡∏õ‡∏¥‡∏î realtime listener ‡∏à‡∏≤‡∏Å Firestore **********/
    function startRealtime() {
      const q = query(tasksCol, orderBy("due"));
      onSnapshot(q, snapshot => {
        const newTasks = [];
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          newTasks.push({
            id: docSnap.id,
            text: data.text || '',
            due: data.due,
            completed: !!data.completed,
            createdAt: data.createdAt || 0,
            completedAt: data.completedAt || null,
            priority: !!data.priority
          });
        });
        tasks = newTasks;
        renderTasks();
        cleanupCompletedInDb();
      });
    }

    startRealtime();

    setInterval(() => {
      updateRemainingDisplayAll();
    }, 20000);
  </script>

</body>
</html>
